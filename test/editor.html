<!DOCTYPE html>
<html>
<head>
  <title>questionnaire editor</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">

  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.0/vis.min.js" integrity="sha512-CFZV2b4rQq36cxk/HnXzgNxvDJlasmPCZEyrOuLk5oSkLCpw5Ni5LCD9HzFQ96DgE+xd855/HvkRfeK67QOFJw==" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-qriously@1.1.1/dist/vue-qriously.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sha256-uint8array/dist/sha256-uint8array.min.js"></script>

  <style id="compiled-css" type="text/css">
  .v-text-field input {
    font-size: 1.0em;
    text-align: left;
    font-weight: bold;
    color: red;
  }
  </style>

</head>
<body>
  <v-app id="app">
    <v-card
      v-if="format"
    >
      <v-container>
        <v-row dense align="center" justify="center">
          <v-col>
            <h1> フォーム編集画面 </h1>
            <p> ファイルパス： {{ formatPath }}　前回更新日時： {{ format.updated }} </p>
          </v-col>
        </v-row>
        <v-row dense align="center" justify="center">
          <v-col>
            <v-text-field
              v-model="format.title"
              label="フォームのタイトル"
              required
              @change="valueChanged"
            >
            </v-text-field>
          </v-col>
        </v-row>
        <v-row dense align="center" justify="center">
          <v-col>
            <v-text-field
              v-model="format.formatCode"
              label="formatCode"
              required
              @change="valueChanged"
            >
            </v-text-field>
          </v-col>
          <v-col>
            <v-text-field
              v-model="format.versionCode"
              label="versionCode"
              required
              @change="valueChanged"
            >
            </v-text-field>
          </v-col>
          <v-col>
            <v-text-field
              v-model="format.codeFunction"
              label="codeFunction"
              required
              @change="valueChanged"
            >
            </v-text-field>
          </v-col>
        </v-row>
      </v-container>
    </v-card>
    <v-container
      v-if="format"
      v-for="(card, cardIndex) in cards"
      :key="cardIndex"
    >
      <v-card
        outlined
      >
        <v-container fluid>
          <v-row dense align="center" justify="center">
            <v-col md="1" sm="1" xs="1">
              # {{ cardIndex + 1 }}
            </v-col>
            <v-col md="2" sm="3" xs="4">
              <v-select
                v-model="card.type"
                label="項目種別"
                :items="itemTypes"
                @change="valueChanged"
              ></v-select>
            </v-col>
            <v-col>
              <v-spacer />
            </v-col>
            <v-col md="3" sm="4" xs="6">
              <v-btn icon
                @click="addCard(cardIndex)"
              >
                <v-icon> mdi-plus-box-outline </v-icon>
              </v-btn>
              <v-btn icon
                @click="copyCard(cardIndex)"
              >
                <v-icon> mdi-vector-arrange-below </v-icon>
              </v-btn>
              <v-btn icon
                @click="moveCard(cardIndex, -1)"
                :disabled="cardIndex <= 0"
              >
                <v-icon> mdi-chevron-double-up </v-icon>
              </v-btn>
              <v-btn icon
                @click="moveCard(cardIndex, 1)"
                :disabled="cardIndex >= cards.length"
              >
                <v-icon> mdi-chevron-double-down </v-icon>
              </v-btn>
              <v-btn icon
                @click="deleteCard(cardIndex)"
              >
                <v-icon> mdi-trash-can-outline </v-icon>
              </v-btn>
            </v-col>
          </v-row>
        </v-container>
        <v-container
          v-if="card.type=='textInput'"
          fluid
        >
          <v-row dense align="center" justify="center">
            <v-col md="6" sm="7" xs="8">
              <v-text-field
                v-model="card.label"
                label="入力項目の質問文"
                required
                @change="valueChanged"
              >
              </v-text-field>
            </v-col>
            <v-col md="2" sm="3" xs="4">
              <v-text-field
                v-model="card.counter"
                label="文字数制限"
                type="number"
                @change="valueChanged"
              >
              </v-text-field>
            </v-col>
          </v-row>
        </v-container>
        <v-container
          v-if="card.type=='radioGroup'"
          fluid
        >
          <v-row dense align="center" justify="center">
            <v-col md="8" sm="10" xs="12">
              <v-text-field
                v-model="card.label"
                label="選択グループの共通説明文"
                required
                @change="valueChanged"
              >
              </v-text-field>
            </v-col>
          </v-row>
          <v-row dense align="center" justify="center">
            <v-col md="8" sm="10" xs="12">
              <v-combobox
                v-model="card.radios"
                :items="card.radios"
                label="選択グループ各項目の選択肢（順序あり）"
                multiple
                chips
                @change="valueChanged"
              ></v-combobox>
            </v-col>
          </v-row>
          <v-row
            dense
            align="center" justify="center"
            v-for="(item, itemIndex) in card.items"
            :key="itemIndex"
          >
            <v-col md="5" sm="6" xs="7">
              # {{ itemIndex + 1 }}
              <v-text-field
                v-model="item.label"
                label="項目の質問文"
                md="4"
                @change="valueChanged"
              >
              </v-text-field>
            </v-col>
            <v-col md="2" sm="3" xs="4">
              <v-select
                :value="valueOf(card,item)"
                label="デフォルト値"
                :items="card.radios"
                @change="indexChanged(card,item,$event)"
              ></v-select>
            </v-col>
            <v-col md="1" sm="1" xs="1">
              <v-btn icon
                @click="deleteItem(card, itemIndex)"
              >
                <v-icon> mdi-close </v-icon>
              </v-btn>
            </v-col>
          </v-row>
          <v-row dense align="center" justify="center">
            <v-btn icon
              @click="addItem(card)"
            >
              <v-icon> mdi-plus </v-icon>
              項目を追加
            </v-btn>
          </v-row>
        </v-container>
        <v-container
          v-if="card.type=='radio'"
          fluid
        >
          <v-row dense align="center" justify="center">
            <v-col md="6" sm="7" xs="8">
              <v-text-field
                v-model="card.label"
                label="入力項目の質問文"
                required
                @change="valueChanged"
              >
              </v-text-field>
            </v-col>
            <v-col md="2" sm="3" xs="4">
              <v-select
                v-model="card.layout"
                label="レイアウト"
                :items="radioLayouts"
                @change="valueChanged"
              ></v-select>
            </v-col>
          </v-row>
          <v-row dense align="center" justify="center">
            <v-col md="6" sm="7" xs="8">
              <v-combobox
                v-model="card.radios"
                :items="card.radios"
                label="選択肢（順序あり）"
                multiple
                chips
                @change="valueChanged"
              ></v-combobox>
            </v-col>
            <v-col md="2" sm="3" xs="4">
              <v-select
                :value="valueOf(card,card)"
                label="デフォルト値"
                :items="card.radios"
                @change="indexChanged(card,card,$event)"
              ></v-select>
            </v-col>
          </v-row>
        </v-container>
        <v-container
          v-if="card.type=='checkbox'"
          fluid
        >
          <v-row dense align="center" justify="center">
            <v-col md="6" sm="7" xs="8">
              <v-text-field
                v-model="card.label"
                label="入力項目の質問文"
                required
                @change="valueChanged"
              >
              </v-text-field>
            </v-col>
            <v-col md="2" sm="3" xs="4">
              <v-select
                v-model="card.layout"
                label="レイアウト"
                :items="radioLayouts"
                @change="valueChanged"
              ></v-select>
            </v-col>
          </v-row>
          <v-row
            dense
            align="center" justify="center"
            v-for="(item, itemIndex) in card.items"
            :key="itemIndex"
          >
            <v-col md="5" sm="6" xs="7">
              # {{ itemIndex + 1 }}
              <v-text-field
                v-model="item.label"
                label="項目の質問文"
                @change="valueChanged"
              >
              </v-text-field>
            </v-col>
            <v-col md="2" sm="3" xs="4">
              <v-checkbox
                v-model="item.value"
                label="デフォルト値"
                false-value="0"
                true-value="1"
                hide-details
                @change="valueChanged"
                >
              </v-checkbox>
            </v-col>
            <v-col md="1" sm="1" xs="1">
              <v-btn icon
                @click="deleteItem(card, itemIndex)"
              >
                <v-icon> mdi-close </v-icon>
              </v-btn>
            </v-col>
          </v-row>
          <v-row dense align="center" justify="center">
            <v-btn icon
              @click="addItem(card)"
            >
              <v-icon> mdi-plus </v-icon>
              項目を追加
            </v-btn>
          </v-row>
        </v-container>
      </v-card>
    </v-container>
    <v-container>
      <v-row align="center" justify="center">
        <v-col>
          <v-btn
            :disabled="!valid"
            width="100%"
            @click="updateFormat"
          >
            <b> フォーマットを更新 </b>
          </v-btn>
          <v-alert
            outlined
            color="blue">
            １つ以上の項目を更新してから、フォーマット更新ボタンが有効になります。<br>
            フォーマット更新のボタンを押すと、フォームのフォーマットが更新されます。<br>
            短期間に繰り返し更新しないよう、少し時間を開けてから更新ください。
          </v-alert>
        </v-col>
      </v-row>
    </v-container>
    <v-container>
      <v-row align="center" justify="center">
        <v-col md="6">
          <v-overlay
            :z-index="zIndex"
            :value="overlay"
            opacity="0.9"
            color="#000000"
          >
            <v-form>
              <v-text-field
                v-model="username"
                label="User Name"
                required
              ></v-text-field>
              <v-text-field
                v-model="password"
                label="Password"
                required
              ></v-text-field>
              <v-btn
                width="100%"
                @click="login"
              >
                ログイン
              </v-btn>
              <v-alert :type="messageType">
                {{ message }}
              </v-alert>
            </v-form>
          </v-overlay>
        </v-col>
      </v-row>
    </v-container>
    <v-container>
      <v-row align="center" justify="center">
        <v-col md="6">
          <v-overlay
            :z-index="zIndex"
            :value="overlayUpdated"
            opacity="0.9"
            color="#ffffff"
          >
            <v-row>
              <v-alert :type="messageType">
                {{ message }}
              </v-alert>
            </v-row>
            <v-row>
              <v-alert
                outlined
                color="blue">
                以下のURLもしくはQRコードから、入力画面を開ます。<br>
                フォームを保存してから入力画面へ反映するまでに数分間かかりますので、しばらくしてからお試しください。<br>
                (早く反映したい場合は、ブラウザのキャッシュデータをクリアしてから再度お試しください)<br>
                {{ inputUrl }}
              </v-alert>
            </v-row>
            <v-row align="center" justify="center">
              <qriously
                class="text-center"
                :value="inputUrl"
                :size="260"
              />
            </v-row>
            <v-row>
              <br>
            </v-row>
            <v-row align="center" justify="center">
              <v-btn
                width="100%"
                @click="reload"
              >
                編集画面へ戻る
              </v-btn>
            </v-row>
          </v-overlay>
        </v-col>
      </v-row>
    </v-container>
  </v-app>

  <script type="module">
  // MUST have module here
  import { Octokit, App } from "https://cdn.skypack.dev/octokit"  // Octokit

  Vue.use(window['vue-qriously'])
  var app = new Vue({
  	el: '#app',
    vuetify: new Vuetify(),
  	data() {
    	return {
        publicUrl: 'https://tohoku-mitc.github.io/pages/',
        formatUrl: 'https://raw.githubusercontent.com/tohoku-mitc/pages/main/',
        dirPath: 'test/',
        formatName: null,
        valid: false,
        username: '',
        password: '',
        message: '',
        messageType: null,
        overlayUpdated: false,
        overlay: true,
        zIndex: 0,
        format: null,
        sha: null,
        octokit: null,
        itemTypes: [
          'textInput',
          'radioGroup',
          'checkbox',
          'radio'
        ],
        radioLayouts: [
          'column',
          'row'
        ],
        select: null
      }
    },
    computed: {
      cards () {
        if (this.format) {
          return this.format.cards
        } else {
          return null
        }
      },
      title () {
        if (this.format) {
          return this.format.title
        } else {
          return 'wating for load data'
        }
      },
      inputUrl () {
        return this.publicUrl + this.dirPath + 'form?format=' + this.formatName
      },
      formatPath () {
        return this.dirPath + this.formatName
      },
      // 現在時刻取得（yyyy/mm/dd hh:mm:ss）
      currentTime () {
        const now = new Date()
        const res = '' + now.getFullYear() +
          '-' + this.padZero(now.getMonth() + 1, 2) +
          '-' + this.padZero(now.getDate(), 2) +
          'T' + this.padZero(now.getHours(), 2) +
          ':' + this.padZero(now.getMinutes(), 2) +
          ':' + this.padZero(now.getSeconds(), 2)
        return res
      }
    },
    created() {
      let uri = window.location.search.substring(1)
      let params = new URLSearchParams(uri)
      let format = params.get("format")
      this.formatName = format

      // this.loadFormat()
    },
    methods: {
      login () {
        this.authGithub()
      },
      reload () {
        this.getContent()
        this.overlayUpdated = false
      },
      async authGithub () {
        const key1 = `ghp_`
        const key2 = `ifNuB6Mfsg`
        const key3 = `lYtTnJKrYx`
        const key5 = `YB06hGdZ`
        const authKey = key1 + key2 + key3 + this.password + key5
        // Create a personal access token at https://github.com/settings/tokens/new?scopes=repo
        this.octokit = new Octokit({ auth: authKey }) // Octokit
        // Compare: https://docs.github.com/en/rest/reference/users#get-the-authenticated-user
        const self = this
        const data = await this.octokit.rest.users.getAuthenticated().then((response) => {
          console.log(response)
          self.message = ''
          self.messageType = null
          self.overlay = false
          self.getContent()
        }).catch(function (error) {
          console.log(error)
          self.message = 'ログイン失敗しました。'
          self.messageType = 'error'
        }).finally(function () {
          // always executed
        })
      },
      async updateFormat () {
        this.valid = false
        this.format.updated = this.currentTime

        this.putContent()
      },
      async getContent () {
        const { data } = await this.octokit.request("GET /repos/{owner}/{repo}/contents/{path}", {
          accept: "application/vnd.github.v3+json",
          owner: "tohoku-mitc",
          repo: "pages",
          path: this.formatPath,
        }).catch(function (error) {
          // handle error
          console.log(error)
          self.message = 'フォーマットをロードできませんでした。?format=フォーマットパスをご確認ください。'
          self.messageType = 'error'
        }).finally(function () {
          // always executed
          self.message = ''
          self.messageType = null
        })
        console.log("data: ", data)
        this.sha = data.sha
        const content = decodeURIComponent(escape(atob(data.content)))
        console.log("content: ", content)
        const format = JSON.parse(content)
        console.log("format: ", format)
        this.format = format
      },
      async putContent () {
        this.overlayUpdated = true

        const content = JSON.stringify(this.format)
        // https://qiita.com/weal/items/1a2af81138cd8f49937d
        const base64 = btoa(unescape(encodeURIComponent(content)))
        // const hex = SHA256.createHash().update(data).digest("hex")
        const self = this
        const response = await this.octokit.request("PUT /repos/{owner}/{repo}/contents/{path}", {
          mediaType: {
            format: "raw",
          },
          owner: "tohoku-mitc",
          repo: "pages",
          path: this.formatPath,
          message: "updated from editor",
          content: base64,
          sha: this.sha
        }).then((response) => {
          console.log("response: ", response)
          self.message = 'フォーム更新が成功しました。しばらくしてから入力画面をお試しください。'
          self.messageType = 'success'
        }).catch(function (error) {
          console.log("error: ", error)
          self.message = 'フォーム更新が失敗しました。しばらくしてから、再度お試しください。'
          self.messageType = 'error'
        }).finally(function () {
          // always executed
        })
      },
      addCard (index) {
        const newCard = {
          "type": "textInput",
          "label": "new Card",
          "items": []
        }
        const newIndex = index + 1
        this.cards.splice(newIndex, 0, newCard)

      },
      copyCard (index) {
        const card = this.cards[index]
        const newCard = { ...card }
        const newIndex = index + 1
        this.cards.splice(newIndex, 0, newCard)
      },
      moveCard (index, direction) {
        const newIndex = index + direction
        if ( newIndex < 0 || newIndex > this.cards.length ) {
          return
        }
        const card = this.cards[index]
        const newCard = { ...card }
        this.cards.splice(index, 1)
        this.cards.splice(newIndex, 0, newCard)
      },
      deleteCard (index) {
        const card = this.cards[index]
        const showIndex = index + 1
        var result = window.confirm('#' + showIndex + ' ' + card.label + ' を削除しますか？')
        if( result ) {
            console.log('OKがクリックされました')
            this.cards.splice(index, 1)
        }
        else {
            console.log('キャンセルがクリックされました')
        }
      },
      addItem (card) {
        const newItem = {
          "label": "new Item"
        }
        card.items.push(newItem)
      },
      deleteItem (card, index) {
        card.items.splice(index, 1)
      },
      valueChanged () {
        if (this.format) {
          this.format.updated = this.currentTime
          this.valid = true
        }
        this.message = ''
        this.messageType = null
      },
      valueOf (card, item) {
        // console.log(card)
        // console.log(item)
        if (item.value >= 0) {
          return card.radios[item.value]
        } else {
          return null
        }
      },
      indexChanged (card, item, event) {
        // console.log(event)
        item.value = card.radios.indexOf(event)
        // console.log(item.value)

        this.valueChanged()
      },
      // 先頭ゼロ付加
      padZero (number, length) {
        let result
        const num = number ? number : 0
        const str = String(Math.round(num))
        const diff = length - str.length
        //console.log('str ' + str + ', diff ' + diff)
        if (diff > 0) {
          result = '0'.repeat(diff) + str
        } else if (diff < 0) {
          result = str.slice( -1 * length )
        } else {
          result = str
        }
        //console.log('result ' + result)
        return result
      }
    }
  })
  </script>
</body>
</html>
