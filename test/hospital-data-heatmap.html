<!DOCTYPE html>
<html>
<head>
  <title>hospital data heatmap</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">

  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-base.min.js" type="text/javascript"></script>
  <script src="https://cdn.anychart.com/releases/v8/js/anychart-heatmap.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-data-adapter.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.0/vis.min.js" integrity="sha512-CFZV2b4rQq36cxk/HnXzgNxvDJlasmPCZEyrOuLk5oSkLCpw5Ni5LCD9HzFQ96DgE+xd855/HvkRfeK67QOFJw==" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.js"></script>

  <style id="compiled-css" type="text/css">
    .clickable {
      cursor: pointer;
    }
  </style>

</head>
<body>
  <div id="app">
    <v-container fluid>
      <v-row no-gutters>
        <v-col
          :cols="showDetail ? 8 : 12"
          style="min-width: 600px;"
          class="flex-grow-1 flex-shrink-0"
          >
          <div id="heatMap" style="height:900px;" @click="heatMapClick"></div>
          <v-btn fixed fab bottom right
            @click="showDetail=!showDetail"
            class="clickable"
            style="bottom: 20px">
              <v-icon v-show="!showDetail">mdi-chevron-right</v-icon>
              <v-icon v-show="showDetail">mdi-chevron-left</v-icon>
          </v-btn>
        </v-col>
        <v-col
          v-if="showDetail"
          cols="4"
          style="min-width: 100px;"
          class="flex-grow-0 flex-shrink-1"
          >
          <div id="columnChart" style="height:320px;"></div>
          <div id="columnChart2" style="height:320px;"></div>
          <div id="pieChart" style="height:320px;"></div>
          <!-- <div id="scatterChart" style="height:600px;"></div> -->
          <!-- <div id="barChart" style="height:600px;"></div> -->
        </v-col>
      </v-row>
    </v-container>
  </div>
  <script>

  var app = new Vue({
  	el: '#app',
    vuetify: new Vuetify(),
  	data() {
    	return {
        heatMapData: [
          [1995,53,50,40,29,28,54,101,672,409,407,402,389,296,324,269,376,301,222,267,221,248,233,266,237,362,1441,381],
          [1996,276,87,70,57,111,126,756,621,471,435,433,396,329,326,363,339,348,372,295,277,282,295,326,407,1651,347,],
          [1997,241,73,42,60,61,375,310,266,247,222,251,195,176,198,197,186,184,177,169,152,138,197,233,783,163,,],
          [1998,273,92,67,87,398,341,297,231,236,198,199,185,179,187,165,175,171,157,156,175,152,216,746,136,,,],
          [1999,303,114,121,526,406,323,304,254,178,219,184,213,191,209,196,183,156,148,185,186,233,788,155,,,,],
          [2000,455,197,753,535,417,328,309,254,245,208,257,220,217,201,187,187,171,166,192,242,873,165,,,,,],
          [2001,904,1584,743,467,393,328,305,279,228,239,233,242,231,190,198,175,178,207,254,866,153,,,,,,],
          [2002,7841,1950,973,677,575,446,386,325,349,321,317,296,264,260,259,251,261,333,1197,264,,,,,,,],
          [2003,7872,1893,929,628,513,468,367,366,340,279,339,284,258,267,245,288,362,1168,193,,,,,,,,],
          [2004,7928,1802,849,585,497,371,401,348,323,297,315,293,246,268,247,342,1072,188,,,,,,,,,],
          [2005,8233,1954,851,637,505,464,371,358,370,301,304,266,267,293,353,1158,253,,,,,,,,,,],
          [2006,8370,2192,999,682,602,521,459,434,383,346,328,321,321,381,1343,270,,,,,,,,,,,],
          [2007,9340,2320,1016,867,611,553,499,460,419,391,395,447,487,1570,282,,,,,,,,,,,,],
          [2008,9073,2144,1104,702,639,564,536,426,407,384,459,501,1625,305,,,,,,,,,,,,,],
          [2009,8703,2380,1002,749,630,560,593,440,450,512,585,1807,290,,,,,,,,,,,,,,],
          [2010,10497,2807,1340,1057,855,810,746,677,679,894,2397,369,,,,,,,,,,,,,,,],
          [2011,10210,2809,1259,855,704,751,668,605,847,2287,390,,,,,,,,,,,,,,,,],
          [2012,10957,3137,1232,980,783,757,754,946,2611,445,,,,,,,,,,,,,,,,,],
          [2013,10834,2988,1336,915,843,825,985,2652,449,,,,,,,,,,,,,,,,,,],
          [2014,10591,3076,1280,1019,816,1102,2843,433,,,,,,,,,,,,,,,,,,,],
          [2015,9948,3092,1290,1026,1058,3291,486,,,,,,,,,,,,,,,,,,,,],
          [2016,9865,2793,1386,1242,3478,559,,,,,,,,,,,,,,,,,,,,,],
          [2017,9894,3264,1796,4235,658,,,,,,,,,,,,,,,,,,,,,,],
          [2018,10234,3882,5116,762,,,,,,,,,,,,,,,,,,,,,,,],
          [2019,11759,8046,1077,,,,,,,,,,,,,,,,,,,,,,,,],
          [2020,13939,2107,,,,,,,,,,,,,,,,,,,,,,,,,],
          [2021,48,,,,,,,,,,,,,,,,,,,,,,,,,,]
        ],
        patientData: [],
        patients: [],
        result: [],
        groups: [],
        groupsM: [],
        groupsF: [],
        countGroups: [],
        types:['循環器','消化器','脳','皮膚科'],
        heatMapChart: null,
        columnChart: null,
        columnChart2: null,
        pieChart: null,
        scatterChart: null,
        barChart: null,
        selected: {
          duration: null,
          year: null,
          count: 0
        },
        showDetail: false
      }
    },
    computed: {
      // computed here
    },
    mounted() {
      this.loadHeatMap()
      this.initPatients()
    },
    methods: {
      initPatients () {
        this.showDetail = true
        const url = "https://tohoku-mitc.github.io/pages/test/patient-data3.csv"
        const self = this
        anychart.data.loadCsvFile(url, function (csv) {
          //console.log('csv', csv)

        	// set data from loaded csv
          var arr = csv.split(/\r\n|\n/)
          const data = []
          for (var i in arr) {
            const row = arr[i].split(',')
            data.push(row)
          }
          self.patientData = data

          // create patients
          const patients = []
          for (var i in data) {
            var row = data[i]
            var sex = (row[0]=='1') ? 'M' : 'F'
            var duration = (row[2]) ? Number(row[2]) : 0
            var patient = {
              sex: sex,
              birth: Number(row[1].trim()),
              duration: duration,
              count: Number(row[3])
            }
            if (i > 0) {
              patients.push(patient)
            }
          }
          //console.log('patients', patients)
          self.patients = patients
        })
      },
      filterPatients () {
        // create a data set
        const self = this
        this.result = this.patients.filter( function( item ) {
          return item.duration >= self.selected.duration
        })
        if (this.result) {
          //console.log('this.result', this.result)
          this.groups = this.groupBy(this.result, 'sex')

          if (this.groups['M']) {
            this.groupsM = this.groupBy(this.groups['M'], 'birth')
          } else {
            this.groupsM = null
          }

          if (this.groups['F']) {
            this.groupsF = this.groupBy(this.groups['F'], 'birth')
          } else {
            this.groupsF = null
          }

          this.countGroups = this.groupBy(this.result, 'count')

        } else {
          this.groups = null
          this.groupsM = null
          this.groupsF = null
          this.countGroups = null
        }
      },
      loadHeatMap () {
        const self = this
        anychart.onDocumentReady(function () {
            //console.log('data', self.heatMapData)

            //convert data
            var data = []
            for (var i in self.heatMapData) {

              let row = self.heatMapData[i]
              let year = row[0] + '年'
              for (var j in row) {
                let col = row[j]
                if (j>0 && col) {
                  let period = (j-1)
                  data.push({x: period, y: year, heat: col})
                }
              }
            }

            // create a chart and set the data
            chart = anychart.heatMap(data)

            var colorScale = anychart.scales.ordinalColor();
            // set color for all points
            colorScale.ranges([
              { less: 100, color: '#FFFDE7' },
              { from: 100, to: 250, color: '#FFF9C4' },
              { from: 250, to: 500, color: '#FFF59D' },
              { from: 500, to: 750, color: '#FFE082' },
              { from: 750, to: 1000, color: '#FFD54F' },
              { from: 1000, to: 2500, color: '#FFCA28' },
              { from: 2500, to: 5000, color: '#FFA726' },
              { from: 5000, to: 7500, color: '#FB8C00' },
              { from: 7500, to: 10000, color: '#F44336' },
              { greater: 10000, color: '#E53935' }
            ]);
            chart.colorScale(colorScale);

            // enable and configure scrollers
            chart.xScroller().enabled(true);
            chart.xZoom().setToPointsCount(27);
            //chart.yScroller().enabled(true);
            chart.yZoom().setToPointsCount(27);

            // listen
            chart.listen('pointClick', function(e) {
              self.selected.duration = e.iterator.get('x');
              self.selected.year = e.iterator.get('y');
              self.selected.count = e.iterator.get('heat');
              //console.log(self.selected)

              self.filterPatients()
              //self.loadBarChart()
              self.loadColumnChart()
              self.loadColumnChart2()
              self.loadPieChart()
              //self.loadScatterChart()
            });

            chart.title('患者の初回入院年度と継続年数のHeatMap');
            chart.title().padding([0, 0, 5, 0]);

            // set the container id
            chart.container("heatMap")

            // initiate drawing the chart
            chart.draw()

            self.heatMapChart = chart
        })
      },
      loadColumnChart () {
        if (this.columnChart) {
          this.columnChart.dispose()
          this.columnChart = null
        }
        if (!this.groups) return

        const self = this
        anychart.onDocumentReady(function () {
          //console.log('duration', self.selected.duration)

          var sortedViewM = null
          if (self.groupsM) {
            var dataM = []
            for (key in self.groupsM) {
              if (key) {
                const group = self.groupsM[key]
                dataM.push([key, group.length])
              }
            }
            var dataSetM = anychart.data.set(dataM)
            var viewM = dataSetM.mapAs()
            sortedViewM = viewM.sort("x","desc")
          }

          var sortedViewF = null
          if (self.groupsF) {
            var dataF = []
            for (key in self.groupsF) {
              if (key) {
                const group = self.groupsF[key]
                dataF.push([key, group.length])
              }
            }
            var dataSetF = anychart.data.set(dataF)
            var viewF = dataSetF.mapAs()
            sortedViewF = viewF.sort("x","desc")
          }

          // create a chart
          self.columnChart = anychart.column();

          // set chart title text settings
          self.columnChart.title('出生年度ごとの患者数');
          self.columnChart.title().padding([0, 0, 5, 0]);

          // force chart to stack values by Y scale.
          self.columnChart.yScale().stackMode('value');

          // turn on chart animation
          var animationSettings = self.columnChart.animation();
          animationSettings.duration(1000);
          animationSettings.enabled(true);

          // set the container id
          self.columnChart.container("columnChart");

          // helper function to setup label settings for all series
          var setupSeriesLabels = function (series, name) {
            series.name(name).stroke('3 #fff 1');
            series.hovered().stroke('3 #fff 1');
          };

          // create a column series and set the data
          if (sortedViewM) {
          var seriesM = self.columnChart.column(sortedViewM);
            seriesM.name('男性');
            seriesM.fill('#2196F3')
            seriesM.stroke('#BBDEFB')
          }

          if (sortedViewF) {
            var seriesF = self.columnChart.column(sortedViewF);
            seriesF.name('女性');
            seriesF.fill('#E91E63')
            seriesF.stroke('#F8BBD0')
          }

          // turn on legend
          self.columnChart.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]);
          // set yAxis labels formatter
          //self.columnChart.yAxis().labels().format('{%Value}{groupsSeparator: }');

          // set titles for axes
          self.columnChart.xAxis().title('患者出生年度');
          self.columnChart.yAxis().title('患者数');

          // initiate drawing the chart
          self.columnChart.draw();
        })
      },
      // 出生年度ごとの入院回数
      loadColumnChart2 () {
        if (this.columnChart2) {
          this.columnChart2.dispose()
          this.columnChart2 = null
        }
        if (!this.groups) return

        const self = this
        anychart.onDocumentReady(function () {
          //console.log('duration', self.selected.duration)

          var sortedViewM = null
          if (self.groupsM) {
            var dataM = []
            for (key in self.groupsM) {
              if (key) {
                const group = self.groupsM[key]
                let total = group.reduce(function(sum, item){
                  return sum + item.count
                }, 0)
                dataM.push([key, total])
              }
            }
            var dataSetM = anychart.data.set(dataM)
            var viewM = dataSetM.mapAs()
            sortedViewM = viewM.sort("x","desc")
          }

          var sortedViewF = null
          if (self.groupsF) {
            var dataF = []
            for (key in self.groupsF) {
              if (key) {
                const group = self.groupsF[key]
                let total = group.reduce(function(sum, item){
                  return sum + item.count
                }, 0)
                dataF.push([key, total])
              }
            }
            var dataSetF = anychart.data.set(dataF)
            var viewF = dataSetF.mapAs()
            sortedViewF = viewF.sort("x","desc")
          }

          // create a chart
          self.columnChart2 = anychart.column();

          // set chart title text settings
          self.columnChart2.title('出生年度ごとの入院回数');
          self.columnChart2.title().padding([0, 0, 5, 0]);

          // force chart to stack values by Y scale.
          self.columnChart2.yScale().stackMode('value');

          // turn on chart animation
          var animationSettings = self.columnChart2.animation();
          animationSettings.duration(1000);
          animationSettings.enabled(true);

          // set the container id
          self.columnChart2.container("columnChart2");

          // helper function to setup label settings for all series
          var setupSeriesLabels = function (series, name) {
            series.name(name).stroke('3 #fff 1');
            series.hovered().stroke('3 #fff 1');
          };

          // create a column series and set the data
          if (sortedViewM) {
          var seriesM = self.columnChart2.column(sortedViewM);
            seriesM.name('男性');
            seriesM.fill('#2196F3')
            seriesM.stroke('#BBDEFB')
          }

          if (sortedViewF) {
            var seriesF = self.columnChart2.column(sortedViewF);
            seriesF.name('女性');
            seriesF.fill('#E91E63')
            seriesF.stroke('#F8BBD0')
          }

          // turn on legend
          self.columnChart2.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]);
          // set yAxis labels formatter
          //self.columnChart2.yAxis().labels().format('{%Value}{groupsSeparator: }');

          // set titles for axes
          self.columnChart2.xAxis().title('患者出生年度');
          self.columnChart2.yAxis().title('患者入院回数');

          // initiate drawing the chart
          self.columnChart2.draw();
        })
      },
      // 入院回数ごとの患者人数
      loadPieChart () {
        if (this.pieChart) {
          this.pieChart.dispose()
          this.pieChart = null
        }
        if (!this.countGroups) return

        const self = this
        anychart.onDocumentReady(function () {
          //console.log('duration', self.selected.duration)

          var data = []
          for (var key in self.countGroups) {
            const group = self.countGroups[key]
            data.push({x:key+'回', value:group.length})
          }

          // create a chart
          self.pieChart = anychart.pie(data);

          // set chart title text settings
          self.pieChart.title('入院回数ごとの人数割合');
          self.pieChart.title().padding([0, 0, 5, 0]);

          // turn on chart animation
          var animationSettings = self.pieChart.animation();
          animationSettings.duration(1000);
          animationSettings.enabled(true);

          // set the container id
          self.pieChart.container("pieChart");

          // turn on legend
          self.pieChart.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]).position("top")

          // initiate drawing the chart
          self.pieChart.draw();
        })
      },
      heatMapClick(event) {
        //console.log('event', event)
        //console.log('selected', this.heatMapChart.selected())
      },
      groupBy(xs, key) {
        return xs.reduce(function(rv, x) {
          (rv[x[key]] = rv[x[key]] || []).push(x);
          return rv;
        }, {});
      }
    }
  })
  </script>
</body>
</html>
